<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø± | HealthPay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #f59e0b; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .transaction-row { transition: all 0.2s; }
        .transaction-row:hover { background-color: #fffbeb; }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-failed { background: #fee2e2; color: #991b1b; }
        .status-refunded { background: #e0e7ff; color: #3730a3; }
        .loading-skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- Header -->
<header class="bg-gradient-to-r from-amber-500 to-orange-600 text-white shadow-lg sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="dashboard.html" class="text-white hover:text-amber-100">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <div>
                    <h1 class="text-xl font-bold">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h1>
                    <p class="text-amber-100 text-sm">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="apiStatus" class="px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
                <button onclick="exportTransactions()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    ØªØµØ¯ÙŠØ±
                </button>
            </div>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-gray-500 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</p>
            <p class="text-2xl font-bold text-gray-800" id="totalRevenue">-</p>
            <p class="text-green-600 text-xs mt-1">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-gray-500 text-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p>
            <p class="text-2xl font-bold text-gray-800" id="totalCount">-</p>
            <p class="text-gray-400 text-xs mt-1">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-gray-500 text-sm">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</p>
            <p class="text-2xl font-bold text-gray-800" id="avgTransaction">-</p>
            <p class="text-gray-400 text-xs mt-1">Ø¬.Ù…</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-gray-500 text-sm">Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹</p>
            <p class="text-2xl font-bold text-red-500" id="totalRefunded">-</p>
            <p class="text-gray-400 text-xs mt-1">Ø¬.Ù…</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>
            <select id="statusFilter" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
                <option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option>
                <option value="failed">ÙØ§Ø´Ù„Ø©</option>
                <option value="refunded">Ù…Ø³ØªØ±Ø¬Ø¹Ø©</option>
            </select>
            <select id="typeFilter" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="payment_request">Ø·Ù„Ø¨ Ø¯ÙØ¹</option>
                <option value="qr">QR Code</option>
                <option value="api">API</option>
            </select>
            <input type="date" id="dateFrom" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500">
            <input type="date" id="dateTo" class="px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500">
            <button onclick="applyFilters()" class="bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600 transition-colors">
                ØªØ·Ø¨ÙŠÙ‚
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="bg-white rounded-xl shadow-sm p-8 text-center">
        <div class="spinner mx-auto mb-4"></div>
        <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden bg-red-50 rounded-xl shadow-sm p-8 text-center">
        <svg class="w-16 h-16 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h3 class="text-lg font-medium text-red-800 mb-2">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p class="text-red-600 mb-4" id="errorMessage">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</p>
        <button onclick="loadTransactions()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">
            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        </button>
    </div>

    <!-- Transactions Table -->
    <div id="transactionsContainer" class="hidden bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-right px-4 py-3 text-sm font-medium text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</th>
                        <th class="text-right px-4 py-3 text-sm font-medium text-gray-500">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th class="text-right px-4 py-3 text-sm font-medium text-gray-500">Ø§Ù„Ù†ÙˆØ¹</th>
                        <th class="text-right px-4 py-3 text-sm font-medium text-gray-500">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th class="text-right px-4 py-3 text-sm font-medium text-gray-500">Ø§Ù„Ø±Ø³ÙˆÙ…</th>
                        <th class="text-right px-4 py-3 text-sm font-medium text-gray-500">Ø§Ù„ØµØ§ÙÙŠ</th>
                        <th class="text-right px-4 py-3 text-sm font-medium text-gray-500">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th class="text-right px-4 py-3 text-sm font-medium text-gray-500">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th class="text-center px-4 py-3 text-sm font-medium text-gray-500">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="transactionsTable" class="divide-y">
                    <!-- Filled dynamically -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="flex items-center justify-between px-4 py-3 border-t">
            <p class="text-gray-500 text-sm" id="paginationInfo">Ø¹Ø±Ø¶ 1-10 Ù…Ù† 0 Ù…Ø¹Ø§Ù…Ù„Ø©</p>
            <div class="flex gap-2">
                <button onclick="prevPage()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50" id="prevBtn" disabled>
                    Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                <button onclick="nextPage()" class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 disabled:opacity-50" id="nextBtn" disabled>
                    Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Transaction Details Modal -->
<div id="detailsModal" class="hidden fixed inset-0 z-50">
    <div class="modal-overlay absolute inset-0" onclick="closeDetailsModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6" id="detailsContent"></div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50"></div>

<script>
// ============================================
// API Configuration
// ============================================
const API_CONFIG = {
    baseUrl: window.location.hostname === 'localhost' 
        ? 'http://104.248.245.150:4000/graphql'
        : 'http://104.248.245.150:4000/graphql',
    timeout: 10000,
    retries: 2
};

// Get auth token from localStorage
function getAuthToken() {
    return localStorage.getItem('healthpay_token') || '';
}

// Get merchant ID from localStorage or session
function getMerchantId() {
    return localStorage.getItem('healthpay_merchant_id') || 'merchant-demo-001';
}

// ============================================
// GraphQL Client
// ============================================
async function graphqlRequest(query, variables = {}) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
    
    try {
        const response = await fetch(API_CONFIG.baseUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({ query, variables }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.errors) {
            throw new Error(data.errors[0].message);
        }
        
        return data.data;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

// ============================================
// GraphQL Queries
// ============================================
const QUERIES = {
    merchantTransactions: `
        query MerchantTransactions($merchantId: ID!, $status: String, $type: String, $limit: Int, $offset: Int, $startDate: DateTime, $endDate: DateTime) {
            merchantTransactions(merchantId: $merchantId, status: $status, type: $type, limit: $limit, offset: $offset, startDate: $startDate, endDate: $endDate) {
                transactions {
                    id
                    customer { id name phone email }
                    type
                    amount
                    fee
                    net
                    status
                    reference
                    description
                    createdAt
                }
                totalCount
                analytics {
                    totalRevenue
                    totalRefunded
                    avgTransaction
                }
            }
        }
    `,
    
    transactionDetails: `
        query TransactionDetails($id: ID!) {
            transaction(id: $id) {
                id
                customer { id name phone email }
                type
                amount
                fee
                net
                status
                reference
                description
                createdAt
                metadata
            }
        }
    `,
    
    refundTransaction: `
        mutation RefundTransaction($id: ID!, $reason: String) {
            refundTransaction(id: $id, reason: $reason) {
                success
                message
                transaction { id status }
            }
        }
    `
};

// ============================================
// State
// ============================================
let transactions = [];
let filteredTransactions = [];
let currentPage = 1;
let totalCount = 0;
const perPage = 10;
let isUsingMockData = false;

// ============================================
// Initialize
// ============================================
async function init() {
    setupEventListeners();
    await loadTransactions();
}

function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
    document.getElementById('statusFilter').addEventListener('change', () => loadTransactions());
    document.getElementById('typeFilter').addEventListener('change', () => loadTransactions());
}

// ============================================
// Load Transactions from API
// ============================================
async function loadTransactions() {
    showLoading();
    
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    const variables = {
        merchantId: getMerchantId(),
        limit: perPage,
        offset: (currentPage - 1) * perPage,
        status: statusFilter !== 'all' ? statusFilter : null,
        type: typeFilter !== 'all' ? typeFilter : null,
        startDate: dateFrom || null,
        endDate: dateTo ? dateTo + 'T23:59:59Z' : null
    };
    
    try {
        const data = await graphqlRequest(QUERIES.merchantTransactions, variables);
        
        transactions = data.merchantTransactions.transactions;
        totalCount = data.merchantTransactions.totalCount;
        
        // Update summary from API analytics
        const analytics = data.merchantTransactions.analytics;
        document.getElementById('totalRevenue').textContent = formatCurrency(analytics.totalRevenue);
        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('avgTransaction').textContent = formatCurrency(analytics.avgTransaction);
        document.getElementById('totalRefunded').textContent = formatCurrency(analytics.totalRefunded);
        
        updateApiStatus(true);
        isUsingMockData = false;
        
        applyFilters();
        showTransactions();
        
    } catch (error) {
        console.error('API Error:', error);
        
        // Fallback to mock data
        loadMockData();
        updateApiStatus(false);
        isUsingMockData = true;
        
        updateSummary();
        applyFilters();
        showTransactions();
    }
}

// ============================================
// Mock Data Fallback
// ============================================
function loadMockData() {
    const now = new Date();
    const types = ['payment_request', 'qr', 'api'];
    const statuses = ['completed', 'completed', 'completed', 'completed', 'pending', 'refunded', 'failed'];
    const customers = [
        { name: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', phone: '01012345678' },
        { name: 'Ø³Ø§Ø±Ø© Ù…Ø­Ù…ÙˆØ¯', phone: '01123456789' },
        { name: 'Ø£Ø­Ù…Ø¯ Ø­Ø³Ù†', phone: '01234567890' },
        { name: 'ÙØ§Ø·Ù…Ø© Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', phone: '01098765432' },
        { name: 'Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯', phone: '01111111111' },
        { name: 'Ù†ÙˆØ± Ø§Ù„Ø¯ÙŠÙ†', phone: '01222222222' },
        { name: 'Ù…Ø±ÙŠÙ… Ø³Ø¹ÙŠØ¯', phone: '01555555555' },
        { name: 'ÙŠÙˆØ³Ù Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡', phone: '01066666666' }
    ];
    
    transactions = [];
    
    for (let i = 0; i < 50; i++) {
        const amount = Math.floor(Math.random() * 2000) + 100;
        const fee = Math.round(amount * 0.025 * 100) / 100;
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        const customer = customers[Math.floor(Math.random() * customers.length)];
        
        transactions.push({
            id: `TXN-${String(1000 + i).padStart(6, '0')}`,
            customer: {
                name: customer.name,
                phone: customer.phone
            },
            type: types[Math.floor(Math.random() * types.length)],
            amount,
            fee,
            net: amount - fee,
            status,
            reference: `REF-${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
            createdAt: new Date(now - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
            description: 'Ø¯ÙØ¹ Ù…Ù‚Ø§Ø¨Ù„ Ø®Ø¯Ù…Ø§Øª'
        });
    }
    
    transactions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    totalCount = transactions.length;
}

function updateSummary() {
    const completed = transactions.filter(t => t.status === 'completed');
    const refunded = transactions.filter(t => t.status === 'refunded');
    
    const totalRevenue = completed.reduce((sum, t) => sum + t.net, 0);
    const avgTransaction = completed.length > 0 ? totalRevenue / completed.length : 0;
    const totalRefunded = refunded.reduce((sum, t) => sum + t.amount, 0);
    
    document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
    document.getElementById('totalCount').textContent = completed.length;
    document.getElementById('avgTransaction').textContent = formatCurrency(avgTransaction);
    document.getElementById('totalRefunded').textContent = formatCurrency(totalRefunded);
}

// ============================================
// UI State Management
// ============================================
function showLoading() {
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('errorState').classList.add('hidden');
    document.getElementById('transactionsContainer').classList.add('hidden');
}

function showTransactions() {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('errorState').classList.add('hidden');
    document.getElementById('transactionsContainer').classList.remove('hidden');
}

function showError(message) {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('errorState').classList.remove('hidden');
    document.getElementById('transactionsContainer').classList.add('hidden');
    document.getElementById('errorMessage').textContent = message;
}

function updateApiStatus(connected) {
    const statusEl = document.getElementById('apiStatus');
    if (connected) {
        statusEl.textContent = 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
        statusEl.className = 'px-2 py-1 rounded-full text-xs bg-green-100 text-green-700';
    } else {
        statusEl.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
        statusEl.className = 'px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-700';
    }
}

// ============================================
// Filtering & Rendering
// ============================================
function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    // For API mode, filtering is server-side except search
    if (!isUsingMockData && !search) {
        filteredTransactions = transactions;
    } else {
        const statusFilter = document.getElementById('statusFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        filteredTransactions = transactions.filter(t => {
            // Search
            if (search) {
                const searchStr = `${t.id} ${t.customer.name} ${t.customer.phone} ${t.reference}`.toLowerCase();
                if (!searchStr.includes(search)) return false;
            }
            
            // For mock data, apply all filters client-side
            if (isUsingMockData) {
                if (statusFilter !== 'all' && t.status !== statusFilter) return false;
                if (typeFilter !== 'all' && t.type !== typeFilter) return false;
                if (dateFrom && new Date(t.createdAt) < new Date(dateFrom)) return false;
                if (dateTo && new Date(t.createdAt) > new Date(dateTo + 'T23:59:59')) return false;
            }
            
            return true;
        });
    }
    
    renderTransactions();
}

function renderTransactions() {
    const displayTotal = isUsingMockData ? filteredTransactions.length : totalCount;
    const totalPages = Math.ceil(displayTotal / perPage);
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    
    const pageTransactions = isUsingMockData 
        ? filteredTransactions.slice(start, end)
        : filteredTransactions;
    
    if (pageTransactions.length === 0) {
        document.getElementById('transactionsTable').innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-12 text-gray-500">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«
                </td>
            </tr>
        `;
    } else {
        const html = pageTransactions.map(t => `
            <tr class="transaction-row cursor-pointer" onclick="openDetails('${t.id}')">
                <td class="px-4 py-3">
                    <span class="font-mono text-sm text-gray-800">${t.id}</span>
                </td>
                <td class="px-4 py-3">
                    <p class="font-medium text-gray-800">${t.customer.name}</p>
                    <p class="text-gray-500 text-xs">${t.customer.phone}</p>
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 ${getTypeClass(t.type)} rounded-full text-xs">${getTypeLabel(t.type)}</span>
                </td>
                <td class="px-4 py-3 font-medium text-gray-800">${formatCurrency(t.amount)}</td>
                <td class="px-4 py-3 text-gray-500 text-sm">${formatCurrency(t.fee)}</td>
                <td class="px-4 py-3 font-bold text-green-600">${formatCurrency(t.net)}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 ${getStatusClass(t.status)} rounded-full text-xs">${getStatusLabel(t.status)}</span>
                </td>
                <td class="px-4 py-3 text-gray-500 text-sm">${formatDateTime(t.createdAt)}</td>
                <td class="px-4 py-3 text-center">
                    <button onclick="event.stopPropagation(); openDetails('${t.id}')" class="text-amber-600 hover:text-amber-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </button>
                </td>
            </tr>
        `).join('');
        
        document.getElementById('transactionsTable').innerHTML = html;
    }
    
    // Pagination
    const displayStart = Math.min(start + 1, displayTotal);
    const displayEnd = Math.min(end, displayTotal);
    document.getElementById('paginationInfo').textContent = 
        `Ø¹Ø±Ø¶ ${displayStart}-${displayEnd} Ù…Ù† ${displayTotal} Ù…Ø¹Ø§Ù…Ù„Ø©`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        if (isUsingMockData) {
            renderTransactions();
        } else {
            loadTransactions();
        }
    }
}

function nextPage() {
    const displayTotal = isUsingMockData ? filteredTransactions.length : totalCount;
    const totalPages = Math.ceil(displayTotal / perPage);
    if (currentPage < totalPages) {
        currentPage++;
        if (isUsingMockData) {
            renderTransactions();
        } else {
            loadTransactions();
        }
    }
}

// ============================================
// Details Modal
// ============================================
async function openDetails(id) {
    const t = transactions.find(x => x.id === id);
    if (!t) return;
    
    document.getElementById('detailsContent').innerHTML = `
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</h3>
            <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Status & Amount -->
        <div class="text-center mb-6">
            <span class="px-3 py-1 ${getStatusClass(t.status)} rounded-full text-sm">${getStatusLabel(t.status)}</span>
            <p class="text-3xl font-bold text-gray-800 mt-3">${formatCurrency(t.amount)} Ø¬.Ù…</p>
            <p class="text-gray-500 mt-1">${t.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</p>
        </div>
        
        <!-- Transaction Info -->
        <div class="bg-gray-50 rounded-xl p-4 space-y-3 mb-6">
            <div class="flex justify-between">
                <span class="text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</span>
                <span class="font-mono text-gray-800">${t.id}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Ø§Ù„Ù…Ø±Ø¬Ø¹</span>
                <span class="font-mono text-gray-800">${t.reference}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Ø§Ù„Ù†ÙˆØ¹</span>
                <span class="text-gray-800">${getTypeLabel(t.type)}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                <span class="text-gray-800">${formatDateTime(t.createdAt)}</span>
            </div>
        </div>
        
        <!-- Customer Info -->
        <div class="bg-gray-50 rounded-xl p-4 space-y-3 mb-6">
            <h4 class="font-medium text-gray-800 mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
            <div class="flex justify-between">
                <span class="text-gray-500">Ø§Ù„Ø§Ø³Ù…</span>
                <span class="text-gray-800">${t.customer.name}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span>
                <span class="text-gray-800">${t.customer.phone}</span>
            </div>
        </div>
        
        <!-- Financial Breakdown -->
        <div class="bg-amber-50 rounded-xl p-4 space-y-3 mb-6">
            <h4 class="font-medium text-amber-800 mb-2">Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
            <div class="flex justify-between">
                <span class="text-amber-700">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ</span>
                <span class="text-amber-800">${formatCurrency(t.amount)} Ø¬.Ù…</span>
            </div>
            <div class="flex justify-between">
                <span class="text-amber-700">Ø§Ù„Ø±Ø³ÙˆÙ… (2.5%)</span>
                <span class="text-amber-800">-${formatCurrency(t.fee)} Ø¬.Ù…</span>
            </div>
            <hr class="border-amber-200">
            <div class="flex justify-between font-bold">
                <span class="text-amber-800">ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</span>
                <span class="text-green-600">${formatCurrency(t.net)} Ø¬.Ù…</span>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="flex gap-3">
            ${t.status === 'completed' ? `
                <button onclick="initiateRefund('${t.id}')" class="flex-1 py-3 bg-red-100 text-red-600 rounded-xl font-medium hover:bg-red-200">
                    Ø§Ø³ØªØ±Ø¬Ø§Ø¹
                </button>
            ` : ''}
            <button onclick="downloadReceipt('${t.id}')" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200">
                ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ÙŠØµØ§Ù„
            </button>
            <button onclick="closeDetailsModal()" class="flex-1 py-3 bg-amber-500 text-white rounded-xl font-medium hover:bg-amber-600">
                Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    `;
    
    document.getElementById('detailsModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeDetailsModal() {
    document.getElementById('detailsModal').classList.add('hidden');
    document.body.style.overflow = '';
}

// ============================================
// Actions
// ============================================
async function initiateRefund(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ')) return;
    
    try {
        if (!isUsingMockData) {
            await graphqlRequest(QUERIES.refundTransaction, { id, reason: 'Merchant initiated refund' });
        }
        
        // Update local state
        const t = transactions.find(x => x.id === id);
        if (t) {
            t.status = 'refunded';
        }
        
        updateSummary();
        applyFilters();
        closeDetailsModal();
        showToast('ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹');
    }
}

function downloadReceipt(id) {
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ÙŠØµØ§Ù„...');
    // Would generate PDF receipt
}

function exportTransactions() {
    const headers = ['Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©', 'Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø§Ù„Ø±Ø³ÙˆÙ…', 'Ø§Ù„ØµØ§ÙÙŠ', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„ØªØ§Ø±ÙŠØ®'];
    const rows = filteredTransactions.map(t => [
        t.id,
        t.customer.name,
        t.customer.phone,
        getTypeLabel(t.type),
        t.amount,
        t.fee,
        t.net,
        getStatusLabel(t.status),
        formatDateTime(t.createdAt)
    ]);
    
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `transactions-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª');
}

// ============================================
// Helpers
// ============================================
function getTypeClass(type) {
    const classes = {
        'payment_request': 'bg-amber-100 text-amber-700',
        'qr': 'bg-green-100 text-green-700',
        'api': 'bg-blue-100 text-blue-700'
    };
    return classes[type] || 'bg-gray-100 text-gray-600';
}

function getTypeLabel(type) {
    const labels = {
        'payment_request': 'Ø·Ù„Ø¨ Ø¯ÙØ¹',
        'qr': 'QR Code',
        'api': 'API'
    };
    return labels[type] || type;
}

function getStatusClass(status) {
    const classes = {
        'completed': 'status-completed',
        'pending': 'status-pending',
        'failed': 'status-failed',
        'refunded': 'status-refunded'
    };
    return classes[status] || 'bg-gray-100 text-gray-600';
}

function getStatusLabel(status) {
    const labels = {
        'completed': 'Ù…ÙƒØªÙ…Ù„Ø©',
        'pending': 'Ù…Ø¹Ù„Ù‚Ø©',
        'failed': 'ÙØ§Ø´Ù„Ø©',
        'refunded': 'Ù…Ø³ØªØ±Ø¬Ø¹Ø©'
    };
    return labels[status] || status;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-EG', { minimumFractionDigits: 2 }).format(amount || 0);
}

function formatDateTime(date) {
    return new Date(date).toLocaleDateString('ar-EG', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

// Initialize
init();
</script>

</body>
</html>
