<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ - Ø§Ù„ØªØ§Ø¬Ø± | HealthPay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #f59e0b; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-expired { background: #fee2e2; color: #991b1b; }
        .status-cancelled { background: #e5e7eb; color: #374151; }
        .tab-active { border-bottom: 2px solid #f59e0b; color: #f59e0b; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20">

<!-- Header -->
<header class="bg-gradient-to-r from-amber-500 to-orange-600 text-white sticky top-0 z-40">
    <div class="max-w-4xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="dashboard.html" class="text-white hover:text-amber-100">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <div>
                    <h1 class="text-xl font-bold">ğŸ“± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹</h1>
                    <p class="text-amber-100 text-sm">Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹</p>
                </div>
            </div>
            <span id="apiStatus" class="px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-700">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        </div>
    </div>
</header>

<main class="max-w-4xl mx-auto px-4 py-6">
    <!-- Stats Cards -->
    <div class="grid grid-cols-4 gap-3 mb-6">
        <div class="bg-white rounded-xl p-3 text-center shadow-sm">
            <p class="text-xl font-bold text-green-600" id="statCollected">-</p>
            <p class="text-gray-500 text-xs">ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„</p>
        </div>
        <div class="bg-white rounded-xl p-3 text-center shadow-sm">
            <p class="text-xl font-bold text-amber-600" id="statPending">-</p>
            <p class="text-gray-500 text-xs">Ù…Ø¹Ù„Ù‚</p>
        </div>
        <div class="bg-white rounded-xl p-3 text-center shadow-sm">
            <p class="text-xl font-bold text-blue-600" id="statPaid">-</p>
            <p class="text-gray-500 text-xs">Ù…Ø¯ÙÙˆØ¹</p>
        </div>
        <div class="bg-white rounded-xl p-3 text-center shadow-sm">
            <p class="text-xl font-bold text-gray-600" id="statRate">-</p>
            <p class="text-gray-500 text-xs">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</p>
        </div>
    </div>

    <!-- Create Button -->
    <button onclick="openCreateModal()" class="w-full bg-amber-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-amber-600 transition-all flex items-center justify-center gap-2 mb-6">
        <span class="text-2xl">â•</span>
        Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯
    </button>

    <!-- Tabs -->
    <div class="flex border-b mb-4 bg-white rounded-t-xl">
        <button onclick="setTab('all')" class="flex-1 py-3 text-center font-medium tab-active" data-tab="all">Ø§Ù„ÙƒÙ„</button>
        <button onclick="setTab('pending')" class="flex-1 py-3 text-center font-medium text-gray-500" data-tab="pending">Ù…Ø¹Ù„Ù‚</button>
        <button onclick="setTab('paid')" class="flex-1 py-3 text-center font-medium text-gray-500" data-tab="paid">Ù…Ø¯ÙÙˆØ¹</button>
        <button onclick="setTab('expired')" class="flex-1 py-3 text-center font-medium text-gray-500" data-tab="expired">Ù…Ù†ØªÙ‡ÙŠ</button>
    </div>

    <!-- Search & Filter -->
    <div class="bg-white rounded-xl p-4 mb-4 shadow-sm">
        <div class="flex gap-3">
            <div class="flex-1 relative">
                <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„ÙˆØµÙ..."
                       class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            <input type="date" id="dateFilter" class="px-4 py-2 border border-gray-200 rounded-lg">
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="space-y-3">
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 skeleton rounded-xl"></div>
                <div class="flex-1">
                    <div class="h-4 skeleton rounded w-32 mb-2"></div>
                    <div class="h-3 skeleton rounded w-24"></div>
                </div>
                <div class="h-6 skeleton rounded w-16"></div>
            </div>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 skeleton rounded-xl"></div>
                <div class="flex-1">
                    <div class="h-4 skeleton rounded w-32 mb-2"></div>
                    <div class="h-3 skeleton rounded w-24"></div>
                </div>
                <div class="h-6 skeleton rounded w-16"></div>
            </div>
        </div>
    </div>

    <!-- Requests List -->
    <div id="requestsList" class="hidden space-y-3">
        <!-- Filled dynamically -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden bg-white rounded-xl p-12 text-center shadow-sm">
        <div class="text-6xl mb-4">ğŸ“­</div>
        <h3 class="text-lg font-bold text-gray-800 mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¯ÙØ¹</h3>
        <p class="text-gray-500 mb-4">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ Ø·Ù„Ø¨ Ø¯ÙØ¹</p>
        <button onclick="openCreateModal()" class="bg-amber-500 text-white px-6 py-2 rounded-lg font-medium">
            Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>
    </div>
</main>

<!-- Create Modal -->
<div id="createModal" class="hidden fixed inset-0 z-50">
    <div class="modal-overlay absolute inset-0" onclick="closeCreateModal()"></div>
    <div class="absolute inset-0 flex items-end md:items-center justify-center">
        <div class="modal-content bg-white rounded-t-3xl md:rounded-2xl shadow-2xl w-full md:max-w-md max-h-[90vh] overflow-y-auto">
            <!-- Step 1: Create Form -->
            <div id="createStep1" class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¯ÙØ¹</h3>
                    <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                
                <form id="createForm" onsubmit="createRequest(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…) *</label>
                        <input type="number" id="amount" required min="1" step="0.01"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500 text-lg"
                               placeholder="0.00">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Ø§Ù„ÙˆØµÙ *</label>
                        <input type="text" id="description" required maxlength="100"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500"
                               placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ø¯ÙØ¹Ø©">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="tel" id="customerPhone" pattern="01[0-9]{9}"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500"
                               placeholder="01xxxxxxxxx">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø·Ù„Ø¨</label>
                        <select id="expiry" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500">
                            <option value="1">Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                            <option value="24" selected>24 Ø³Ø§Ø¹Ø©</option>
                            <option value="72">3 Ø£ÙŠØ§Ù…</option>
                            <option value="168">Ø£Ø³Ø¨ÙˆØ¹</option>
                            <option value="720">Ø´Ù‡Ø±</option>
                            <option value="0">Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªÙ‡Ø§Ø¡</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="reference" maxlength="50"
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-500"
                               placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨">
                    </div>
                    
                    <button type="submit" id="createBtn" class="w-full bg-amber-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-amber-600 transition-colors flex items-center justify-center gap-2">
                        <span id="createBtnText">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹</span>
                        <div id="createSpinner" class="hidden spinner"></div>
                    </button>
                </form>
            </div>
            
            <!-- Step 2: Share -->
            <div id="createStep2" class="hidden p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">âœ…</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹!</h3>
                    <p class="text-gray-500 mt-2">Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø±Ù…Ø² QR Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                </div>
                
                <!-- QR Code -->
                <div class="bg-gray-50 rounded-xl p-6 mb-6">
                    <div id="qrcode" class="flex justify-center mb-4"></div>
                    <p class="text-center text-2xl font-bold text-amber-600" id="createdAmount">0.00 Ø¬.Ù…</p>
                    <p class="text-center text-gray-500 text-sm" id="createdDesc">-</p>
                </div>
                
                <!-- Payment Link -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹</label>
                    <div class="flex gap-2">
                        <input type="text" id="paymentLink" readonly
                               class="flex-1 px-4 py-3 bg-gray-100 border border-gray-200 rounded-xl text-sm">
                        <button onclick="copyLink()" class="px-4 py-3 bg-amber-500 text-white rounded-xl hover:bg-amber-600">
                            ğŸ“‹
                        </button>
                    </div>
                </div>
                
                <!-- Share Options -->
                <div class="grid grid-cols-4 gap-3 mb-6">
                    <button onclick="shareWhatsApp()" class="flex flex-col items-center gap-1 p-3 bg-green-50 rounded-xl hover:bg-green-100">
                        <span class="text-2xl">ğŸ’¬</span>
                        <span class="text-xs text-green-700">ÙˆØ§ØªØ³Ø§Ø¨</span>
                    </button>
                    <button onclick="shareSMS()" class="flex flex-col items-center gap-1 p-3 bg-blue-50 rounded-xl hover:bg-blue-100">
                        <span class="text-2xl">ğŸ“±</span>
                        <span class="text-xs text-blue-700">SMS</span>
                    </button>
                    <button onclick="shareEmail()" class="flex flex-col items-center gap-1 p-3 bg-red-50 rounded-xl hover:bg-red-100">
                        <span class="text-2xl">ğŸ“§</span>
                        <span class="text-xs text-red-700">Ø¥ÙŠÙ…ÙŠÙ„</span>
                    </button>
                    <button onclick="downloadQR()" class="flex flex-col items-center gap-1 p-3 bg-purple-50 rounded-xl hover:bg-purple-100">
                        <span class="text-2xl">â¬‡ï¸</span>
                        <span class="text-xs text-purple-700">ØªØ­Ù…ÙŠÙ„ QR</span>
                    </button>
                </div>
                
                <button onclick="closeCreateModal(); loadRequests();" class="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div id="detailsModal" class="hidden fixed inset-0 z-50">
    <div class="modal-overlay absolute inset-0" onclick="closeDetailsModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6" id="detailsContent"></div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50"></div>

<script>
// ============================================
// API Configuration
// ============================================
const API_CONFIG = {
    baseUrl: window.location.hostname === 'localhost' 
        ? 'http://104.248.245.150:4000/graphql'
        : 'http://104.248.245.150:4000/graphql',
    paymentBaseUrl: 'https://pay.healthpay.tech/pay/',
    timeout: 10000
};

function getAuthToken() {
    return localStorage.getItem('healthpay_token') || '';
}

function getMerchantId() {
    return localStorage.getItem('healthpay_merchant_id') || 'merchant-demo-001';
}

// ============================================
// GraphQL Client
// ============================================
async function graphqlRequest(query, variables = {}) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
    
    try {
        const response = await fetch(API_CONFIG.baseUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({ query, variables }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        if (data.errors) throw new Error(data.errors[0].message);
        
        return data.data;
    } catch (error) {
        clearTimeout(timeoutId);
        throw error;
    }
}

// ============================================
// GraphQL Queries & Mutations
// ============================================
const QUERIES = {
    paymentRequests: `
        query PaymentRequests($merchantId: ID!, $status: String, $limit: Int, $offset: Int) {
            paymentRequests(merchantId: $merchantId, status: $status, limit: $limit, offset: $offset) {
                requests {
                    id
                    amount
                    description
                    status
                    customerPhone
                    customerName
                    reference
                    paymentLink
                    expiresAt
                    paidAt
                    createdAt
                }
                stats {
                    totalCollected
                    pendingCount
                    paidCount
                    conversionRate
                }
            }
        }
    `,
    
    createPaymentRequest: `
        mutation CreatePaymentRequest($input: PaymentRequestInput!) {
            createPaymentRequest(input: $input) {
                id
                amount
                description
                paymentLink
                expiresAt
            }
        }
    `,
    
    cancelPaymentRequest: `
        mutation CancelPaymentRequest($id: ID!) {
            cancelPaymentRequest(id: $id) {
                success
                message
            }
        }
    `
};

// ============================================
// State
// ============================================
let requests = [];
let currentTab = 'all';
let createdRequest = null;
let isUsingMockData = false;

// ============================================
// Initialize
// ============================================
async function init() {
    setupEventListeners();
    await loadRequests();
}

function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', debounce(filterRequests, 300));
    document.getElementById('dateFilter').addEventListener('change', filterRequests);
}

// ============================================
// Load Requests
// ============================================
async function loadRequests() {
    showLoading();
    
    try {
        const data = await graphqlRequest(QUERIES.paymentRequests, {
            merchantId: getMerchantId(),
            status: currentTab !== 'all' ? currentTab : null,
            limit: 50,
            offset: 0
        });
        
        requests = data.paymentRequests.requests;
        updateStats(data.paymentRequests.stats);
        updateApiStatus(true);
        isUsingMockData = false;
        
    } catch (error) {
        console.error('API Error:', error);
        loadMockData();
        updateApiStatus(false);
        isUsingMockData = true;
    }
    
    filterRequests();
}

// ============================================
// Mock Data
// ============================================
function loadMockData() {
    const now = new Date();
    requests = [
        { id: 'PR-001', amount: 350.00, description: 'Ø¯ÙØ¹ Ù…Ù‚Ø§Ø¨Ù„ Ø£Ø¯ÙˆÙŠØ©', status: 'paid', customerPhone: '01012345678', customerName: 'Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯', reference: 'INV-2024-001', expiresAt: null, paidAt: new Date(now - 3600000).toISOString(), createdAt: new Date(now - 7200000).toISOString() },
        { id: 'PR-002', amount: 520.00, description: 'ÙØ­ÙˆØµØ§Øª Ø·Ø¨ÙŠØ©', status: 'pending', customerPhone: '01123456789', customerName: null, reference: 'INV-2024-002', expiresAt: new Date(now + 86400000).toISOString(), paidAt: null, createdAt: new Date(now - 1800000).toISOString() },
        { id: 'PR-003', amount: 180.00, description: 'Ø§Ø³ØªØ´Ø§Ø±Ø© Ø·Ø¨ÙŠØ©', status: 'expired', customerPhone: '01234567890', customerName: null, reference: null, expiresAt: new Date(now - 86400000).toISOString(), paidAt: null, createdAt: new Date(now - 172800000).toISOString() },
        { id: 'PR-004', amount: 890.00, description: 'Ø£Ø¯ÙˆÙŠØ© Ø´Ù‡Ø±ÙŠØ©', status: 'paid', customerPhone: '01098765432', customerName: 'ÙØ§Ø·Ù…Ø© Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', reference: 'INV-2024-003', expiresAt: null, paidAt: new Date(now - 43200000).toISOString(), createdAt: new Date(now - 86400000).toISOString() },
        { id: 'PR-005', amount: 245.00, description: 'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ÙŠØ©', status: 'pending', customerPhone: null, customerName: null, reference: 'REF-123', expiresAt: new Date(now + 172800000).toISOString(), paidAt: null, createdAt: new Date().toISOString() },
        { id: 'PR-006', amount: 1200.00, description: 'Ø¹Ù„Ø§Ø¬ Ø·Ø¨ÙŠØ¹ÙŠ', status: 'cancelled', customerPhone: '01555555555', customerName: null, reference: null, expiresAt: null, paidAt: null, createdAt: new Date(now - 259200000).toISOString() }
    ];
    
    // Calculate stats
    const paid = requests.filter(r => r.status === 'paid');
    const pending = requests.filter(r => r.status === 'pending');
    const total = requests.filter(r => r.status !== 'cancelled').length;
    
    updateStats({
        totalCollected: paid.reduce((sum, r) => sum + r.amount, 0),
        pendingCount: pending.length,
        paidCount: paid.length,
        conversionRate: total > 0 ? Math.round((paid.length / total) * 100) : 0
    });
}

// ============================================
// UI Updates
// ============================================
function updateStats(stats) {
    document.getElementById('statCollected').textContent = formatCurrency(stats.totalCollected);
    document.getElementById('statPending').textContent = stats.pendingCount;
    document.getElementById('statPaid').textContent = stats.paidCount;
    document.getElementById('statRate').textContent = stats.conversionRate + '%';
}

function showLoading() {
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('requestsList').classList.add('hidden');
    document.getElementById('emptyState').classList.add('hidden');
}

function filterRequests() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    
    let filtered = requests;
    
    // Tab filter
    if (currentTab !== 'all') {
        filtered = filtered.filter(r => r.status === currentTab);
    }
    
    // Search filter
    if (search) {
        filtered = filtered.filter(r => 
            r.id.toLowerCase().includes(search) ||
            r.description.toLowerCase().includes(search) ||
            (r.reference && r.reference.toLowerCase().includes(search)) ||
            (r.customerPhone && r.customerPhone.includes(search))
        );
    }
    
    // Date filter
    if (dateFilter) {
        filtered = filtered.filter(r => 
            new Date(r.createdAt).toDateString() === new Date(dateFilter).toDateString()
        );
    }
    
    renderRequests(filtered);
}

function renderRequests(filteredRequests) {
    document.getElementById('loadingState').classList.add('hidden');
    
    if (filteredRequests.length === 0) {
        document.getElementById('requestsList').classList.add('hidden');
        document.getElementById('emptyState').classList.remove('hidden');
        return;
    }
    
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('requestsList').classList.remove('hidden');
    
    document.getElementById('requestsList').innerHTML = filteredRequests.map(r => `
        <div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow cursor-pointer" onclick="openDetails('${r.id}')">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center text-amber-600 font-bold">
                    ${r.status === 'paid' ? 'âœ…' : r.status === 'pending' ? 'â³' : r.status === 'expired' ? 'â°' : 'âŒ'}
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <p class="font-bold text-gray-800">${formatCurrency(r.amount)} Ø¬.Ù…</p>
                        <span class="px-2 py-0.5 status-${r.status} rounded-full text-xs">${getStatusLabel(r.status)}</span>
                    </div>
                    <p class="text-gray-500 text-sm">${r.description}</p>
                    <p class="text-gray-400 text-xs mt-1">${r.id} â€¢ ${formatDate(r.createdAt)}</p>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    `).join('');
}

function setTab(tab) {
    currentTab = tab;
    
    // Update tab styles
    document.querySelectorAll('[data-tab]').forEach(el => {
        el.classList.remove('tab-active', 'text-amber-600');
        el.classList.add('text-gray-500');
    });
    document.querySelector(`[data-tab="${tab}"]`).classList.add('tab-active', 'text-amber-600');
    document.querySelector(`[data-tab="${tab}"]`).classList.remove('text-gray-500');
    
    filterRequests();
}

function updateApiStatus(connected) {
    const statusEl = document.getElementById('apiStatus');
    if (connected) {
        statusEl.textContent = 'Ù…ØªØµÙ„';
        statusEl.className = 'px-2 py-1 rounded-full text-xs bg-green-100 text-green-700';
    } else {
        statusEl.textContent = 'Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
        statusEl.className = 'px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-700';
    }
}

// ============================================
// Create Request
// ============================================
function openCreateModal() {
    document.getElementById('createModal').classList.remove('hidden');
    document.getElementById('createStep1').classList.remove('hidden');
    document.getElementById('createStep2').classList.add('hidden');
    document.getElementById('createForm').reset();
    document.body.style.overflow = 'hidden';
}

function closeCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function createRequest(e) {
    e.preventDefault();
    
    const btn = document.getElementById('createBtn');
    const btnText = document.getElementById('createBtnText');
    const spinner = document.getElementById('createSpinner');
    
    btn.disabled = true;
    btnText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
    spinner.classList.remove('hidden');
    
    const amount = parseFloat(document.getElementById('amount').value);
    const description = document.getElementById('description').value;
    const customerPhone = document.getElementById('customerPhone').value || null;
    const expiry = parseInt(document.getElementById('expiry').value);
    const reference = document.getElementById('reference').value || null;
    
    try {
        if (!isUsingMockData) {
            const data = await graphqlRequest(QUERIES.createPaymentRequest, {
                input: {
                    merchantId: getMerchantId(),
                    amount,
                    description,
                    customerPhone,
                    expiryHours: expiry,
                    reference
                }
            });
            
            createdRequest = data.createPaymentRequest;
        } else {
            // Mock creation
            const id = 'PR-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            createdRequest = {
                id,
                amount,
                description,
                paymentLink: API_CONFIG.paymentBaseUrl + id,
                expiresAt: expiry > 0 ? new Date(Date.now() + expiry * 3600000).toISOString() : null
            };
            
            // Add to local list
            requests.unshift({
                id: createdRequest.id,
                amount,
                description,
                status: 'pending',
                customerPhone,
                reference,
                expiresAt: createdRequest.expiresAt,
                paidAt: null,
                customerName: null,
                createdAt: new Date().toISOString()
            });
        }
        
        showShareStep();
        
    } catch (error) {
        console.error('Error creating request:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨');
    }
    
    btn.disabled = false;
    btnText.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹';
    spinner.classList.add('hidden');
}

function showShareStep() {
    document.getElementById('createStep1').classList.add('hidden');
    document.getElementById('createStep2').classList.remove('hidden');
    
    // Update display
    document.getElementById('createdAmount').textContent = formatCurrency(createdRequest.amount) + ' Ø¬.Ù…';
    document.getElementById('createdDesc').textContent = createdRequest.description;
    document.getElementById('paymentLink').value = createdRequest.paymentLink;
    
    // Generate QR Code
    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = '';
    new QRCode(qrContainer, {
        text: createdRequest.paymentLink,
        width: 200,
        height: 200,
        colorDark: '#1f2937',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });
}

// ============================================
// Share Functions
// ============================================
function copyLink() {
    const link = document.getElementById('paymentLink').value;
    navigator.clipboard.writeText(link);
    showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·');
}

function shareWhatsApp() {
    const link = document.getElementById('paymentLink').value;
    const text = `Ø·Ù„Ø¨ Ø¯ÙØ¹ Ù…Ù† HealthPay\nØ§Ù„Ù…Ø¨Ù„Øº: ${formatCurrency(createdRequest.amount)} Ø¬.Ù…\n${createdRequest.description}\n\nØ§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†:\n${link}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

function shareSMS() {
    const link = document.getElementById('paymentLink').value;
    const text = `Ø·Ù„Ø¨ Ø¯ÙØ¹ HealthPay: ${formatCurrency(createdRequest.amount)} Ø¬.Ù… - ${link}`;
    window.open(`sms:?body=${encodeURIComponent(text)}`, '_blank');
}

function shareEmail() {
    const link = document.getElementById('paymentLink').value;
    const subject = `Ø·Ù„Ø¨ Ø¯ÙØ¹ - ${formatCurrency(createdRequest.amount)} Ø¬.Ù…`;
    const body = `Ø·Ù„Ø¨ Ø¯ÙØ¹ Ù…Ù† HealthPay\n\nØ§Ù„Ù…Ø¨Ù„Øº: ${formatCurrency(createdRequest.amount)} Ø¬.Ù…\nØ§Ù„ÙˆØµÙ: ${createdRequest.description}\n\nØ±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹:\n${link}`;
    window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
}

function downloadQR() {
    const canvas = document.querySelector('#qrcode canvas');
    if (canvas) {
        const link = document.createElement('a');
        link.download = `payment-qr-${createdRequest.id}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø±Ù…Ø² QR');
    }
}

// ============================================
// Details Modal
// ============================================
function openDetails(id) {
    const r = requests.find(x => x.id === id);
    if (!r) return;
    
    const paymentLink = API_CONFIG.paymentBaseUrl + r.id;
    
    document.getElementById('detailsContent').innerHTML = `
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-800">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
            <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
        </div>
        
        <div class="text-center mb-6">
            <span class="px-3 py-1 status-${r.status} rounded-full text-sm">${getStatusLabel(r.status)}</span>
            <p class="text-3xl font-bold text-gray-800 mt-3">${formatCurrency(r.amount)} Ø¬.Ù…</p>
            <p class="text-gray-500 mt-1">${r.description}</p>
        </div>
        
        ${r.status === 'pending' ? `
            <div class="bg-gray-50 rounded-xl p-4 mb-6">
                <div id="detailQR" class="flex justify-center mb-3"></div>
                <div class="flex gap-2">
                    <input type="text" value="${paymentLink}" readonly class="flex-1 px-3 py-2 bg-white border rounded-lg text-sm">
                    <button onclick="navigator.clipboard.writeText('${paymentLink}'); showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·');" class="px-3 py-2 bg-amber-500 text-white rounded-lg">ğŸ“‹</button>
                </div>
            </div>
        ` : ''}
        
        <div class="space-y-3 mb-6">
            <div class="flex justify-between py-2 border-b">
                <span class="text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</span>
                <span class="font-mono text-gray-800">${r.id}</span>
            </div>
            ${r.reference ? `
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-500">Ø§Ù„Ù…Ø±Ø¬Ø¹</span>
                    <span class="text-gray-800">${r.reference}</span>
                </div>
            ` : ''}
            ${r.customerPhone ? `
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                    <span class="text-gray-800">${r.customerPhone}</span>
                </div>
            ` : ''}
            <div class="flex justify-between py-2 border-b">
                <span class="text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</span>
                <span class="text-gray-800">${formatDateTime(r.createdAt)}</span>
            </div>
            ${r.expiresAt ? `
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</span>
                    <span class="text-gray-800">${formatDateTime(r.expiresAt)}</span>
                </div>
            ` : ''}
            ${r.paidAt ? `
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</span>
                    <span class="text-green-600">${formatDateTime(r.paidAt)}</span>
                </div>
            ` : ''}
            ${r.customerName ? `
                <div class="flex justify-between py-2 border-b">
                    <span class="text-gray-500">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                    <span class="text-gray-800">${r.customerName}</span>
                </div>
            ` : ''}
        </div>
        
        <div class="flex gap-3">
            ${r.status === 'pending' ? `
                <button onclick="cancelRequest('${r.id}')" class="flex-1 py-3 bg-red-100 text-red-600 rounded-xl font-medium hover:bg-red-200">
                    Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
                </button>
            ` : ''}
            <button onclick="closeDetailsModal()" class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200">
                Ø¥ØºÙ„Ø§Ù‚
            </button>
        </div>
    `;
    
    document.getElementById('detailsModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Generate QR for pending requests
    if (r.status === 'pending') {
        setTimeout(() => {
            const qrContainer = document.getElementById('detailQR');
            if (qrContainer) {
                new QRCode(qrContainer, {
                    text: paymentLink,
                    width: 150,
                    height: 150,
                    colorDark: '#1f2937',
                    colorLight: '#ffffff'
                });
            }
        }, 100);
    }
}

function closeDetailsModal() {
    document.getElementById('detailsModal').classList.add('hidden');
    document.body.style.overflow = '';
}

async function cancelRequest(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
    
    try {
        if (!isUsingMockData) {
            await graphqlRequest(QUERIES.cancelPaymentRequest, { id });
        }
        
        // Update local state
        const r = requests.find(x => x.id === id);
        if (r) r.status = 'cancelled';
        
        closeDetailsModal();
        filterRequests();
        showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨');
        
    } catch (error) {
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
    }
}

// ============================================
// Helpers
// ============================================
function getStatusLabel(status) {
    const labels = { 'pending': 'Ù…Ø¹Ù„Ù‚', 'paid': 'Ù…Ø¯ÙÙˆØ¹', 'expired': 'Ù…Ù†ØªÙ‡ÙŠ', 'cancelled': 'Ù…Ù„ØºÙŠ' };
    return labels[status] || status;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-EG', { minimumFractionDigits: 2 }).format(amount || 0);
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
}

function formatDateTime(dateStr) {
    return new Date(dateStr).toLocaleDateString('ar-EG', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
}

// Initialize
init();
</script>

</body>
</html>
