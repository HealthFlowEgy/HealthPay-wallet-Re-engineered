# ==================================================================================
# Kong Gateway Declarative Configuration (v3.4+)
# ==================================================================================
# 
# This file contains the complete Kong configuration for HealthPay Ledger V2 API
# 
# Features:
# - API Gateway with routing
# - JWT Authentication
# - Rate limiting (Redis-backed)
# - CORS
# - Request/Response transformation
# - API versioning (URL path-based)
# - Logging & monitoring
# - Circuit breaker via upstream health checks
# 
# Apply with: deck sync --state kong-config.yaml
#
# ==================================================================================

_format_version: "3.0"
_transform: true

# ==================== Services ====================

services:
  # Auth Service (v2)
  - name: healthpay-auth-v2
    url: http://auth-service:3001
    protocol: http
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 3
    
    routes:
      - name: auth-request-otp
        methods: [POST]
        paths: [/v2/auth/request-otp]
        strip_path: false
        preserve_host: false
        
      - name: auth-verify-otp
        methods: [POST]
        paths: [/v2/auth/verify-otp]
        strip_path: false
        
      - name: auth-refresh
        methods: [POST]
        paths: [/v2/auth/refresh]
        strip_path: false

    plugins:
      # CORS
      - name: cors
        config:
          origins:
            - https://app.healthpay.eg
            - https://staging.healthpay.eg
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Authorization
            - Content-Type
            - X-Request-ID
          exposed_headers:
            - X-RateLimit-Limit
            - X-RateLimit-Remaining
            - X-Request-ID
          credentials: true
          max_age: 3600
      
      # Rate Limiting (auth endpoints)
      - name: rate-limiting
        config:
          second: 5
          minute: 20
          hour: 100
          policy: redis
          redis_host: redis.healthpay.svc.cluster.local
          redis_port: 6379
          redis_timeout: 2000
          fault_tolerant: true
          hide_client_headers: false
      
      # Request Transformer
      - name: request-transformer
        config:
          add:
            headers:
              - X-Gateway:kong
              - X-Gateway-Version:3.4
      
      # Logging
      - name: file-log
        config:
          path: /var/log/kong/auth.log
          reopen: true

  # Wallet Service (v2)
  - name: healthpay-wallet-v2
    url: http://wallet-service:3002
    protocol: http
    connect_timeout: 5000
    write_timeout: 10000
    read_timeout: 10000
    retries: 3
    
    routes:
      - name: wallet-create
        methods: [POST]
        paths: [/v2/wallets]
        strip_path: false
        
      - name: wallet-list
        methods: [GET]
        paths: [/v2/wallets]
        strip_path: false
        
      - name: wallet-get
        methods: [GET]
        paths: [~/v2/wallets/[0-9a-f-]+$]
        strip_path: false
        
      - name: wallet-update
        methods: [PATCH]
        paths: [~/v2/wallets/[0-9a-f-]+$]
        strip_path: false
        
      - name: wallet-balance
        methods: [GET]
        paths: [~/v2/wallets/[0-9a-f-]+/balance$]
        strip_path: false

    plugins:
      # JWT Authentication (required for all wallet endpoints)
      - name: jwt
        config:
          key_claim_name: iss
          secret_is_base64: false
          run_on_preflight: true
          maximum_expiration: 3600
          claims_to_verify:
            - exp
      
      # Rate Limiting (per authenticated user)
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          day: 10000
          policy: redis
          redis_host: redis.healthpay.svc.cluster.local
          redis_port: 6379
          fault_tolerant: true
          limit_by: consumer  # Rate limit per user
      
      # Response Caching (balance endpoint)
      - name: proxy-cache
        config:
          strategy: memory
          content_type:
            - application/json
          cache_ttl: 5  # 5 seconds
          cache_control: false
      
      # CORS
      - name: cors
        config:
          origins: ["*"]
          methods: [GET, POST, PATCH, OPTIONS]
          credentials: true

  # Payment Service (v2)
  - name: healthpay-payment-v2
    url: http://payment-service:3003
    protocol: http
    connect_timeout: 5000
    write_timeout: 30000  # Longer timeout for payments
    read_timeout: 30000
    retries: 0  # No retries for payments (idempotency required)
    
    routes:
      - name: payment-create
        methods: [POST]
        paths: [/v2/payments]
        strip_path: false
        
      - name: payment-list
        methods: [GET]
        paths: [/v2/payments]
        strip_path: false
        
      - name: payment-get
        methods: [GET]
        paths: [~/v2/payments/[0-9a-f-]+$]
        strip_path: false
        
      - name: payment-cancel
        methods: [POST]
        paths: [~/v2/payments/[0-9a-f-]+/cancel$]
        strip_path: false

    plugins:
      # JWT Authentication
      - name: jwt
        config:
          key_claim_name: iss
          secret_is_base64: false
      
      # Rate Limiting (strict for payments)
      - name: rate-limiting
        config:
          minute: 30
          hour: 200
          policy: redis
          redis_host: redis.healthpay.svc.cluster.local
          redis_port: 6379
          limit_by: consumer
      
      # Idempotency (prevent duplicate payments)
      - name: request-termination
        enabled: false  # Placeholder for custom idempotency plugin
      
      # Logging
      - name: file-log
        config:
          path: /var/log/kong/payments.log
          reopen: true

  # Transaction Service (v2)
  - name: healthpay-transaction-v2
    url: http://transaction-service:3004
    protocol: http
    
    routes:
      - name: transaction-list
        methods: [GET]
        paths: [/v2/transactions]
        
      - name: transaction-get
        methods: [GET]
        paths: [~/v2/transactions/[0-9a-f-]+$]
        
      - name: transaction-export
        methods: [POST]
        paths: [/v2/transactions/export]

    plugins:
      # JWT Authentication
      - name: jwt
        config:
          key_claim_name: iss
      
      # Rate Limiting
      - name: rate-limiting
        config:
          minute: 60
          hour: 500
          policy: redis
          redis_host: redis.healthpay.svc.cluster.local
          redis_port: 6379
          limit_by: consumer

  # Payment Gateway - Fawry
  - name: healthpay-gateway-fawry
    url: https://atfawry.fawrystaging.com
    protocol: https
    
    routes:
      - name: fawry-charge
        methods: [POST]
        paths: [/v2/payment-gateways/fawry/charge]
        strip_path: true
        
    plugins:
      # JWT Authentication
      - name: jwt
        config:
          key_claim_name: iss
      
      # Rate Limiting (external service)
      - name: rate-limiting
        config:
          minute: 10
          hour: 100
          policy: redis
          redis_host: redis.healthpay.svc.cluster.local
          redis_port: 6379
          limit_by: consumer

  # Payment Gateway - Paymob
  - name: healthpay-gateway-paymob
    url: https://accept.paymob.com/api
    protocol: https
    
    routes:
      - name: paymob-checkout
        methods: [POST]
        paths: [/v2/payment-gateways/paymob/checkout]
        strip_path: true
        
    plugins:
      # JWT Authentication
      - name: jwt
        config:
          key_claim_name: iss
      
      # Rate Limiting
      - name: rate-limiting
        config:
          minute: 10
          hour: 100
          policy: redis
          redis_host: redis.healthpay.svc.cluster.local
          redis_port: 6379
          limit_by: consumer

  # Webhook Endpoints (no auth - signature verification in service)
  - name: healthpay-webhooks
    url: http://webhook-service:3005
    protocol: http
    
    routes:
      - name: webhook-fawry
        methods: [POST]
        paths: [/v2/webhooks/fawry]
        strip_path: false
        
      - name: webhook-paymob
        methods: [POST]
        paths: [/v2/webhooks/paymob]
        strip_path: false

    plugins:
      # Rate Limiting (prevent webhook spam)
      - name: rate-limiting
        config:
          minute: 60
          hour: 1000
          policy: redis
          redis_host: redis.healthpay.svc.cluster.local
          redis_port: 6379
      
      # IP Restriction (only allow known gateway IPs)
      - name: ip-restriction
        config:
          allow:
            - 41.33.0.0/16      # Fawry IP range
            - 197.58.0.0/16     # Paymob IP range
            - 127.0.0.1         # Localhost for testing

  # Admin/Health Endpoints (no auth)
  - name: healthpay-admin
    url: http://admin-service:3006
    protocol: http
    
    routes:
      - name: health-check
        methods: [GET]
        paths: [/v2/health]
        strip_path: false
        
      - name: metrics
        methods: [GET]
        paths: [/v2/metrics]
        strip_path: false

    plugins:
      # No authentication for health checks
      # Rate limiting still applies
      - name: rate-limiting
        config:
          second: 10
          minute: 60

# ==================== Global Plugins ====================

plugins:
  # Correlation ID (add unique ID to every request)
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 10  # 10MB max

  # Prometheus Metrics
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true

  # Response Transformer (add standard headers)
  - name: response-transformer
    config:
      add:
        headers:
          - X-Gateway:kong
          - X-Powered-By:HealthFlow

# ==================== Upstream Health Checks ====================
# These enable circuit-breaker-like behavior

upstreams:
  - name: auth-service-upstream
    algorithm: round-robin
    slots: 100
    healthchecks:
      active:
        type: http
        http_path: /health
        timeout: 1
        concurrency: 10
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          tcp_failures: 2
          http_failures: 3
          timeouts: 3
      passive:
        type: http
        healthy:
          successes: 3
        unhealthy:
          tcp_failures: 2
          http_failures: 5
          timeouts: 3
    targets:
      - target: auth-service:3001
        weight: 100

  - name: wallet-service-upstream
    algorithm: round-robin
    slots: 100
    healthchecks:
      active:
        type: http
        http_path: /health
        timeout: 1
        concurrency: 10
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
      passive:
        healthy:
          successes: 3
        unhealthy:
          http_failures: 5
          timeouts: 3
    targets:
      - target: wallet-service:3002
        weight: 100

  - name: payment-service-upstream
    algorithm: round-robin
    slots: 100
    healthchecks:
      active:
        type: http
        http_path: /health
        timeout: 2
        concurrency: 5
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 2
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3
          timeouts: 2
    targets:
      - target: payment-service:3003
        weight: 100

# ==================== Consumers (API Users) ====================

consumers:
  - username: healthpay-mobile-app
    custom_id: mobile-app-v2
    tags:
      - mobile
      - production
    
    jwt_secrets:
      - key: healthpay-mobile-v2
        algorithm: HS256
        secret: ${MOBILE_APP_JWT_SECRET}

  - username: healthpay-web-app
    custom_id: web-app-v2
    tags:
      - web
      - production
    
    jwt_secrets:
      - key: healthpay-web-v2
        algorithm: HS256
        secret: ${WEB_APP_JWT_SECRET}

  - username: healthpay-admin-portal
    custom_id: admin-portal-v2
    tags:
      - admin
      - internal
    
    jwt_secrets:
      - key: healthpay-admin-v2
        algorithm: HS256
        secret: ${ADMIN_PORTAL_JWT_SECRET}

# ==================== Tags ====================
tags:
  - v2
  - production
  - healthpay-ledger
