<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงูุชุฌุงุฑ - HealthPay Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .sidebar { width: 260px; }
        .main-content { margin-right: 260px; }
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(100%); position: fixed; z-index: 50; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; }
        }
        .nav-item:hover { background: rgba(245, 158, 11, 0.1); }
        .nav-item.active { background: rgba(245, 158, 11, 0.15); border-right: 3px solid #f59e0b; }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-suspended { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-100">

<!-- Sidebar -->
<aside class="sidebar fixed top-0 right-0 h-full bg-white shadow-lg transition-transform duration-300">
    <div class="p-6 border-b">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center text-white font-bold">HP</div>
            <div>
                <h1 class="font-bold text-gray-800">HealthPay</h1>
                <p class="text-xs text-gray-500">ููุญุฉ ุงูุฅุฏุงุฑุฉ</p>
            </div>
        </div>
    </div>
    
    <nav class="p-4">
        <p class="text-xs text-gray-400 mb-3 px-3">ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ</p>
        <a href="dashboard.html" class="nav-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-700 mb-1">
            <span>๐</span><span>ููุญุฉ ุงูุชุญูู</span>
        </a>
        <a href="users.html" class="nav-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-700 mb-1">
            <span>๐ฅ</span><span>ุงููุณุชุฎุฏููู</span>
        </a>
        <a href="merchants.html" class="nav-item active flex items-center gap-3 px-3 py-3 rounded-lg text-gray-700 mb-1">
            <span>๐ช</span><span>ุงูุชุฌุงุฑ</span>
        </a>
        <a href="transactions.html" class="nav-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-700 mb-1">
            <span>๐ณ</span><span>ุงููุนุงููุงุช</span>
        </a>
        <a href="billers.html" class="nav-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-700 mb-1">
            <span>๐</span><span>ูุฒูุฏู ุงูุฎุฏูุงุช</span>
        </a>
        <p class="text-xs text-gray-400 mb-3 mt-6 px-3">ุงูุฅุนุฏุงุฏุงุช</p>
        <a href="settings.html" class="nav-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-700 mb-1">
            <span>โ๏ธ</span><span>ุงูุฅุนุฏุงุฏุงุช</span>
        </a>
    </nav>
    
    <div class="absolute bottom-0 right-0 left-0 p-4 border-t">
        <div class="flex items-center gap-3 mb-3">
            <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 font-bold">A</div>
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-800" id="adminName">Admin</p>
                <p class="text-xs text-gray-500" id="adminEmail">admin@healthpay.tech</p>
            </div>
        </div>
        <button onclick="logout()" class="w-full py-2 text-red-600 text-sm hover:bg-red-50 rounded-lg transition">ุชุณุฌูู ุงูุฎุฑูุฌ</button>
    </div>
</aside>

<!-- Main Content -->
<main class="main-content min-h-screen p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">ุฅุฏุงุฑุฉ ุงูุชุฌุงุฑ</h1>
            <p class="text-gray-500">ุนุฑุถ ูุฅุฏุงุฑุฉ ุญุณุงุจุงุช ุงูุชุฌุงุฑ ูุงูุตูุฏููุงุช</p>
        </div>
        <button onclick="openAddModal()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition flex items-center gap-2">
            <span>โ</span>
            ุฅุถุงูุฉ ุชุงุฌุฑ
        </button>
    </div>
    
    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-2xl font-bold text-gray-800" id="statTotal">0</p>
            <p class="text-gray-500 text-sm">ุฅุฌูุงูู ุงูุชุฌุงุฑ</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-2xl font-bold text-green-600" id="statActive">0</p>
            <p class="text-gray-500 text-sm">ูุดุท</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-2xl font-bold text-amber-600" id="statPending">0</p>
            <p class="text-gray-500 text-sm">ูู ุงูุชุธุงุฑ ุงูููุงููุฉ</p>
        </div>
        <div class="bg-white rounded-xl p-4 shadow-sm">
            <p class="text-2xl font-bold text-blue-600" id="statRevenue">0</p>
            <p class="text-gray-500 text-sm">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</p>
        </div>
    </div>
    
    <!-- Pending Approvals Alert -->
    <div id="pendingAlert" class="hidden bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
        <div class="flex items-center gap-3">
            <span class="text-2xl">โ๏ธ</span>
            <div class="flex-1">
                <p class="font-medium text-amber-800">ููุงู <span id="pendingCount">0</span> ุทูุจ ุชุณุฌูู ูู ุงูุชุธุงุฑ ุงูููุงููุฉ</p>
                <p class="text-sm text-amber-600">ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุทูุจุงุช ูุงูููุงููุฉ ุนูููุง ุฃู ุฑูุถูุง</p>
            </div>
            <button onclick="filterByPending()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">ุนุฑุถ ุงูุทูุจุงุช</button>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <input type="text" id="searchInput" placeholder="ุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุงุชู ุฃู ุงุณู ุงููุดุงุท..."
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <select id="statusFilter" class="px-4 py-2 border border-gray-200 rounded-lg">
                <option value="">ูู ุงูุญุงูุงุช</option>
                <option value="ACTIVE">ูุดุท</option>
                <option value="PENDING">ูู ุงูุชุธุงุฑ ุงูููุงููุฉ</option>
                <option value="SUSPENDED">ููููู</option>
            </select>
            <select id="typeFilter" class="px-4 py-2 border border-gray-200 rounded-lg">
                <option value="">ูู ุงูุฃููุงุน</option>
                <option value="pharmacy">ุตูุฏููุฉ</option>
                <option value="clinic">ุนูุงุฏุฉ</option>
                <option value="hospital">ูุณุชุดูู</option>
                <option value="lab">ูุนูู</option>
                <option value="other">ุฃุฎุฑู</option>
            </select>
            <button onclick="loadMerchants()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                ๐ ุจุญุซ
            </button>
        </div>
    </div>
    
    <!-- Merchants Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="merchantsGrid">
        <!-- Populated by JS -->
    </div>
    
    <!-- Pagination -->
    <div class="flex justify-between items-center mt-6">
        <p class="text-sm text-gray-500">ุนุฑุถ <span id="showingCount">0</span> ูู <span id="totalCount">0</span></p>
        <div class="flex gap-2">
            <button onclick="prevPage()" id="prevBtn" class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 disabled:opacity-50" disabled>ุงูุณุงุจู</button>
            <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 bg-white border rounded-lg hover:bg-gray-50 disabled:opacity-50">ุงูุชุงูู</button>
        </div>
    </div>
</main>

<!-- Merchant Detail Modal -->
<div id="detailModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-lg font-bold">ุชูุงุตูู ุงูุชุงุฌุฑ</h3>
            <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">โ</button>
        </div>
        <div class="p-6" id="detailContent">
            <!-- Populated by JS -->
        </div>
    </div>
</div>

<!-- Add Merchant Modal -->
<div id="addModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-lg font-bold">ุฅุถุงูุฉ ุชุงุฌุฑ ุฌุฏูุฏ</h3>
            <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600">โ</button>
        </div>
        <form onsubmit="addMerchant(event)" class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงููุณุคูู</label>
                    <input type="text" id="newName" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ุฑูู ุงููุงุชู</label>
                    <input type="tel" id="newPhone" required pattern="01[0125][0-9]{8}" placeholder="01xxxxxxxxx"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงููุดุงุท ุงูุชุฌุงุฑู</label>
                <input type="text" id="newBusinessName" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                <input type="email" id="newEmail" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ููุน ุงููุดุงุท</label>
                    <select id="newType" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                        <option value="pharmacy">ุตูุฏููุฉ</option>
                        <option value="clinic">ุนูุงุฏุฉ</option>
                        <option value="hospital">ูุณุชุดูู</option>
                        <option value="lab">ูุนูู</option>
                        <option value="other">ุฃุฎุฑู</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุญุงูุฉ</label>
                    <select id="newStatus" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                        <option value="ACTIVE">ูุดุท</option>
                        <option value="PENDING">ูู ุงูุชุธุงุฑ ุงูููุงููุฉ</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุนููุงู</label>
                <input type="text" id="newAddress" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุฑูู ุงูุถุฑูุจู (ุงุฎุชูุงุฑู)</label>
                <input type="text" id="newTaxId" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeAddModal()" class="flex-1 py-3 border rounded-xl hover:bg-gray-50">ุฅูุบุงุก</button>
                <button type="submit" class="flex-1 py-3 bg-amber-500 text-white rounded-xl hover:bg-amber-600">ุฅุถุงูุฉ</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Merchant Modal -->
<div id="editModal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-md mx-4">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-lg font-bold">ุชุนุฏูู ุจูุงูุงุช ุงูุชุงุฌุฑ</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">โ</button>
        </div>
        <form onsubmit="saveMerchantEdit(event)" class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงููุณุคูู</label>
                <input type="text" id="editName" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุฑูู ุงููุงุชู</label>
                <input type="tel" id="editPhone" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-100">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                <input type="email" id="editEmail" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ุงุณู ุงููุดุงุท ุงูุชุฌุงุฑู</label>
                <input type="text" id="editBusinessName" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ููุน ุงููุดุงุท</label>
                <select id="editType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                    <option value="pharmacy">ุตูุฏููุฉ</option>
                    <option value="clinic">ุนูุงุฏุฉ</option>
                    <option value="hospital">ูุณุชุดูู</option>
                    <option value="lab">ูุนูู</option>
                    <option value="other">ุฃุฎุฑู</option>
                </select>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeEditModal()" class="flex-1 py-3 border rounded-xl hover:bg-gray-50">ุฅูุบุงุก</button>
                <button type="submit" class="flex-1 py-3 bg-amber-500 text-white rounded-xl hover:bg-amber-600">ุญูุธ ุงูุชุนุฏููุงุช</button>
            </div>
        </form>
    </div>
</div>

<script>
// ============================================
// Configuration & State
// ============================================
let merchants = [];
let currentPage = 1;
const pageSize = 9;

// ============================================
// Initialize
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    checkAuth();
    loadMerchants();
    
    document.getElementById('searchInput').addEventListener('input', debounce(filterMerchants, 300));
    document.getElementById('statusFilter').addEventListener('change', filterMerchants);
    document.getElementById('typeFilter').addEventListener('change', filterMerchants);
});

function checkAuth() {
    const token = localStorage.getItem('healthpay_admin_token');
    if (!token) {
        window.location.href = 'index.html';
        return;
    }
    const adminInfo = JSON.parse(localStorage.getItem('healthpay_admin_info') || '{}');
    if (adminInfo.name) document.getElementById('adminName').textContent = adminInfo.name;
    if (adminInfo.email) document.getElementById('adminEmail').textContent = adminInfo.email;
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// ============================================
// Load Merchants
// ============================================
async function loadMerchants() {
    // Mock data
    merchants = [
        { id: 'merchant-demo-001', name: 'ุฃุญูุฏ ูุญููุฏ', phone: '01012345678', email: 'demo@healthpay.tech', businessName: 'ุตูุฏููุฉ ุงูุดูุงุก', type: 'pharmacy', status: 'ACTIVE', address: 'ุดุงุฑุน ุงูุชุญุฑูุฑุ ุงููุงูุฑุฉ', taxId: '123-456-789', revenue: 125000, transactionCount: 342, customers: 89, createdAt: '2025-10-15T10:00:00Z', rating: 4.8 },
        { id: 'merchant-002', name: 'ุณุงุฑุฉ ุฃุญูุฏ', phone: '01123456789', email: 'sara@clinic.com', businessName: 'ุนูุงุฏุฉ ุงูุฃูู', type: 'clinic', status: 'ACTIVE', address: 'ุงููุนุงุฏูุ ุงููุงูุฑุฉ', taxId: '234-567-890', revenue: 89000, transactionCount: 156, customers: 45, createdAt: '2025-11-01T14:00:00Z', rating: 4.5 },
        { id: 'merchant-003', name: 'ูุญูุฏ ุญุณู', phone: '01234567890', email: 'mohamed@pharmacy.com', businessName: 'ุตูุฏููุฉ ุงูููุฑ', type: 'pharmacy', status: 'ACTIVE', address: 'ูุฏููุฉ ูุตุฑุ ุงููุงูุฑุฉ', taxId: '345-678-901', revenue: 67000, transactionCount: 234, customers: 67, createdAt: '2025-11-15T09:00:00Z', rating: 4.2 },
        { id: 'merchant-004', name: 'ูุงุทูุฉ ุนูู', phone: '01098765432', email: 'fatma@lab.com', businessName: 'ูุนูู ุงูุญูุงุฉ', type: 'lab', status: 'PENDING', address: 'ุงูุฒูุงููุ ุงููุงูุฑุฉ', taxId: null, revenue: 0, transactionCount: 0, customers: 0, createdAt: '2026-01-01T16:00:00Z', rating: 0 },
        { id: 'merchant-005', name: 'ุนูู ูุญูุฏ', phone: '01111111111', email: 'ali@hospital.com', businessName: 'ูุณุชุดูู ุงูุณูุงู', type: 'hospital', status: 'ACTIVE', address: 'ุงูุฅุณููุฏุฑูุฉ', taxId: '456-789-012', revenue: 450000, transactionCount: 890, customers: 234, createdAt: '2025-09-01T11:00:00Z', rating: 4.9 },
        { id: 'merchant-006', name: 'ููุฑ ุงูุฏูู', phone: '01222222222', email: 'nour@pharmacy.com', businessName: 'ุตูุฏููุฉ ุงูุฑุญูุฉ', type: 'pharmacy', status: 'SUSPENDED', address: 'ุทูุทุงุ ุงูุบุฑุจูุฉ', taxId: '567-890-123', revenue: 23000, transactionCount: 78, customers: 23, createdAt: '2025-12-01T08:00:00Z', rating: 3.2 },
        { id: 'merchant-007', name: 'ูุฑูู ุนุจุฏุงููู', phone: '01555555555', email: 'mariam@clinic.com', businessName: 'ุนูุงุฏุฉ ุงูุดูุงุก', type: 'clinic', status: 'PENDING', address: 'ุงูููุตูุฑุฉุ ุงูุฏููููุฉ', taxId: null, revenue: 0, transactionCount: 0, customers: 0, createdAt: '2026-01-02T07:00:00Z', rating: 0 },
        { id: 'merchant-008', name: 'ููุณู ุฅุจุฑุงููู', phone: '01666666666', email: 'youssef@lab.com', businessName: 'ูุนูู ุงูุชุญุงููู ุงูุฏูููุฉ', type: 'lab', status: 'ACTIVE', address: 'ุงูุฌูุฒุฉ', taxId: '678-901-234', revenue: 156000, transactionCount: 567, customers: 145, createdAt: '2025-08-15T13:00:00Z', rating: 4.6 },
        { id: 'merchant-009', name: 'ูุฏู ุณุนูุฏ', phone: '01777777777', email: 'huda@pharmacy.com', businessName: 'ุตูุฏููุฉ ุงูุตุญุฉ', type: 'pharmacy', status: 'ACTIVE', address: 'ุฃุณููุท', taxId: '789-012-345', revenue: 34000, transactionCount: 123, customers: 56, createdAt: '2025-12-10T10:00:00Z', rating: 4.0 }
    ];
    
    updateStats();
    filterMerchants();
}

function updateStats() {
    const pending = merchants.filter(m => m.status === 'PENDING');
    
    document.getElementById('statTotal').textContent = merchants.length;
    document.getElementById('statActive').textContent = merchants.filter(m => m.status === 'ACTIVE').length;
    document.getElementById('statPending').textContent = pending.length;
    document.getElementById('statRevenue').textContent = formatCurrency(merchants.reduce((sum, m) => sum + m.revenue, 0));
    
    // Show pending alert
    if (pending.length > 0) {
        document.getElementById('pendingAlert').classList.remove('hidden');
        document.getElementById('pendingCount').textContent = pending.length;
    } else {
        document.getElementById('pendingAlert').classList.add('hidden');
    }
}

function formatCurrency(amount) {
    if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
    if (amount >= 1000) return (amount / 1000).toFixed(0) + 'K';
    return amount.toLocaleString('ar-EG');
}

// ============================================
// Filter & Render
// ============================================
function filterMerchants() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    const type = document.getElementById('typeFilter').value;
    
    let filtered = merchants.filter(m => {
        const matchSearch = !search || 
            m.name.toLowerCase().includes(search) || 
            m.phone.includes(search) ||
            m.businessName.toLowerCase().includes(search);
        const matchStatus = !status || m.status === status;
        const matchType = !type || m.type === type;
        return matchSearch && matchStatus && matchType;
    });
    
    renderMerchants(filtered);
}

function filterByPending() {
    document.getElementById('statusFilter').value = 'PENDING';
    filterMerchants();
}

function renderMerchants(filtered) {
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageMerchants = filtered.slice(start, end);
    
    const grid = document.getElementById('merchantsGrid');
    grid.innerHTML = pageMerchants.map(m => `
        <div class="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition cursor-pointer" onclick="showMerchantDetail('${m.id}')">
            <div class="p-4 border-b">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center text-white text-lg">
                        ${getTypeIcon(m.type)}
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">${m.businessName}</h3>
                        <p class="text-sm text-gray-500">${m.name}</p>
                    </div>
                    <span class="px-2 py-1 rounded-full text-xs status-${m.status.toLowerCase()}">
                        ${getStatusLabel(m.status)}
                    </span>
                </div>
            </div>
            <div class="p-4 space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">ุงูุฅูุฑุงุฏุงุช</span>
                    <span class="font-medium text-green-600">${m.revenue.toLocaleString('ar-EG')} ุฌ.ู</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">ุงููุนุงููุงุช</span>
                    <span class="text-gray-800">${m.transactionCount}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">ุงูุนููุงุก</span>
                    <span class="text-gray-800">${m.customers}</span>
                </div>
                ${m.rating > 0 ? `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">ุงูุชูููู</span>
                    <span class="text-amber-500">โญ ${m.rating}</span>
                </div>
                ` : ''}
            </div>
            ${m.status === 'PENDING' ? `
            <div class="p-4 bg-amber-50 border-t flex gap-2">
                <button onclick="event.stopPropagation(); approveMerchant('${m.id}')" class="flex-1 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">โ ููุงููุฉ</button>
                <button onclick="event.stopPropagation(); rejectMerchant('${m.id}')" class="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">โ ุฑูุถ</button>
            </div>
            ` : ''}
        </div>
    `).join('');
    
    // Update pagination
    document.getElementById('showingCount').textContent = pageMerchants.length;
    document.getElementById('totalCount').textContent = filtered.length;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= filtered.length;
}

function getTypeIcon(type) {
    const icons = { pharmacy: '๐', clinic: '๐ฅ', hospital: '๐จ', lab: '๐ฌ', other: '๐ช' };
    return icons[type] || '๐ช';
}

function getTypeLabel(type) {
    const labels = { pharmacy: 'ุตูุฏููุฉ', clinic: 'ุนูุงุฏุฉ', hospital: 'ูุณุชุดูู', lab: 'ูุนูู', other: 'ุฃุฎุฑู' };
    return labels[type] || type;
}

function getStatusLabel(status) {
    const labels = { ACTIVE: 'ูุดุท', PENDING: 'ูู ุงูุชุธุงุฑ ุงูููุงููุฉ', SUSPENDED: 'ููููู' };
    return labels[status] || status;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
}

// ============================================
// Pagination
// ============================================
function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        filterMerchants();
    }
}

function nextPage() {
    currentPage++;
    filterMerchants();
}

// ============================================
// Modals
// ============================================
function showMerchantDetail(id) {
    const m = merchants.find(x => x.id === id);
    if (!m) return;
    
    document.getElementById('detailContent').innerHTML = `
        <div class="flex items-start gap-4 mb-6">
            <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center text-white text-2xl">
                ${getTypeIcon(m.type)}
            </div>
            <div class="flex-1">
                <h3 class="text-xl font-bold text-gray-800">${m.businessName}</h3>
                <p class="text-gray-500">${m.name} โข ${m.phone}</p>
                <span class="inline-block mt-2 px-3 py-1 rounded-full text-sm status-${m.status.toLowerCase()}">
                    ${getStatusLabel(m.status)}
                </span>
            </div>
        </div>
        
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-green-50 rounded-xl p-4 text-center">
                <p class="text-2xl font-bold text-green-600">${m.revenue.toLocaleString('ar-EG')}</p>
                <p class="text-xs text-gray-500">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</p>
            </div>
            <div class="bg-blue-50 rounded-xl p-4 text-center">
                <p class="text-2xl font-bold text-blue-600">${m.transactionCount}</p>
                <p class="text-xs text-gray-500">ุงููุนุงููุงุช</p>
            </div>
            <div class="bg-purple-50 rounded-xl p-4 text-center">
                <p class="text-2xl font-bold text-purple-600">${m.customers}</p>
                <p class="text-xs text-gray-500">ุงูุนููุงุก</p>
            </div>
        </div>
        
        <div class="space-y-3 mb-6">
            <div class="flex justify-between py-3 border-b">
                <span class="text-gray-500">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</span>
                <span class="text-gray-800">${m.email}</span>
            </div>
            <div class="flex justify-between py-3 border-b">
                <span class="text-gray-500">ููุน ุงููุดุงุท</span>
                <span class="text-gray-800">${getTypeLabel(m.type)}</span>
            </div>
            <div class="flex justify-between py-3 border-b">
                <span class="text-gray-500">ุงูุนููุงู</span>
                <span class="text-gray-800">${m.address || '-'}</span>
            </div>
            <div class="flex justify-between py-3 border-b">
                <span class="text-gray-500">ุงูุฑูู ุงูุถุฑูุจู</span>
                <span class="text-gray-800">${m.taxId || '-'}</span>
            </div>
            <div class="flex justify-between py-3 border-b">
                <span class="text-gray-500">ุชุงุฑูุฎ ุงูุชุณุฌูู</span>
                <span class="text-gray-800">${formatDate(m.createdAt)}</span>
            </div>
            ${m.rating > 0 ? `
            <div class="flex justify-between py-3">
                <span class="text-gray-500">ุงูุชูููู</span>
                <span class="text-amber-500">โญ ${m.rating} / 5</span>
            </div>
            ` : ''}
        </div>
        
        <div class="flex gap-3">
            ${m.status === 'PENDING' ? `
                <button onclick="approveMerchant('${m.id}'); closeDetailModal();" class="flex-1 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600">โ ููุงููุฉ</button>
                <button onclick="rejectMerchant('${m.id}'); closeDetailModal();" class="flex-1 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600">โ ุฑูุถ</button>
            ` : `
                <button onclick="viewTransactions('${m.id}')" class="flex-1 py-3 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-100">๐ณ ุงููุนุงููุงุช</button>
                <button onclick="editMerchant('${m.id}')" class="flex-1 py-3 bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-100">โ๏ธ ุชุนุฏูู</button>
                ${m.status === 'ACTIVE' ? `
                    <button onclick="suspendMerchant('${m.id}')" class="py-3 px-4 bg-red-50 text-red-600 rounded-xl hover:bg-red-100">๐</button>
                ` : `
                    <button onclick="activateMerchant('${m.id}')" class="py-3 px-4 bg-green-50 text-green-600 rounded-xl hover:bg-green-100">๐</button>
                `}
            `}
        </div>
    `;
    
    document.getElementById('detailModal').classList.remove('hidden');
    document.getElementById('detailModal').classList.add('flex');
}

function closeDetailModal() {
    document.getElementById('detailModal').classList.add('hidden');
    document.getElementById('detailModal').classList.remove('flex');
}

function openAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
    document.getElementById('addModal').classList.add('flex');
}

function closeAddModal() {
    document.getElementById('addModal').classList.add('hidden');
    document.getElementById('addModal').classList.remove('flex');
}

// ============================================
// Actions
// ============================================
async function addMerchant(event) {
    event.preventDefault();
    
    const name = document.getElementById('newName').value;
    const phone = document.getElementById('newPhone').value;
    const email = document.getElementById('newEmail').value || null;
    const businessName = document.getElementById('newBusinessName').value;
    const businessType = document.getElementById('newType').value;
    const password = document.getElementById('newPassword')?.value || 'HealthPay123!';
    
    const token = localStorage.getItem('healthpay_admin_token');
    
    try {
        const response = await fetch('http://104.248.245.150:4000/graphql', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            },
            body: JSON.stringify({
                query: `mutation AdminCreateMerchant($input: AdminCreateMerchantInput!) {
                    adminCreateMerchant(input: $input) {
                        success
                        message
                        merchant { id name phone email businessName businessType status createdAt }
                    }
                }`,
                variables: { input: { name, phone, email, businessName, businessType, password } }
            })
        });
        
        const result = await response.json();
        
        if (result.data?.adminCreateMerchant?.success) {
            const newMerchant = result.data.adminCreateMerchant.merchant;
            merchants.unshift({
                id: newMerchant.id,
                name: newMerchant.name,
                phone: newMerchant.phone,
                email: newMerchant.email,
                businessName: newMerchant.businessName,
                type: newMerchant.businessType,
                status: newMerchant.status,
                revenue: 0,
                transactionCount: 0,
                customers: 0,
                createdAt: newMerchant.createdAt,
                rating: 0
            });
            updateStats();
            filterMerchants();
            closeAddModal();
            alert('ุชู ุฅุถุงูุฉ ุงูุชุงุฌุฑ ุจูุฌุงุญ');
        } else {
            alert('ุฎุทุฃ: ' + (result.data?.adminCreateMerchant?.message || result.errors?.[0]?.message || 'ูุดู ูู ุฅุถุงูุฉ ุงูุชุงุฌุฑ'));
        }
    } catch (error) {
        console.error('Error adding merchant:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูุชุงุฌุฑ');
    }
}

function approveMerchant(id) {
    const m = merchants.find(x => x.id === id);
    if (m) {
        m.status = 'ACTIVE';
        updateStats();
        filterMerchants();
        alert('ุชู ุงูููุงููุฉ ุนูู ุงูุชุงุฌุฑ');
    }
}

function rejectMerchant(id) {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฑูุถ ูุฐุง ุงูุชุงุฌุฑุ')) {
        merchants = merchants.filter(m => m.id !== id);
        updateStats();
        filterMerchants();
        alert('ุชู ุฑูุถ ุงูุชุงุฌุฑ');
    }
}

function suspendMerchant(id) {
    const m = merchants.find(x => x.id === id);
    if (m && confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅููุงู ูุฐุง ุงูุชุงุฌุฑุ')) {
        m.status = 'SUSPENDED';
        updateStats();
        filterMerchants();
        closeDetailModal();
    }
}

function activateMerchant(id) {
    const m = merchants.find(x => x.id === id);
    if (m) {
        m.status = 'ACTIVE';
        updateStats();
        filterMerchants();
        closeDetailModal();
    }
}

let editingMerchantId = null;

function editMerchant(id) {
    const m = merchants.find(x => x.id === id);
    if (!m) {
        alert('ุงูุชุงุฌุฑ ุบูุฑ ููุฌูุฏ');
        return;
    }
    
    editingMerchantId = id;
    document.getElementById('editName').value = m.name || '';
    document.getElementById('editPhone').value = m.phone || '';
    document.getElementById('editEmail').value = m.email || '';
    document.getElementById('editBusinessName').value = m.businessName || '';
    document.getElementById('editType').value = m.type || 'other';
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editModal').classList.add('flex');
    closeDetailModal();
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editModal').classList.remove('flex');
    editingMerchantId = null;
}

async function saveMerchantEdit(event) {
    event.preventDefault();
    if (!editingMerchantId) return;
    
    const name = document.getElementById('editName').value;
    const email = document.getElementById('editEmail').value || null;
    const businessName = document.getElementById('editBusinessName').value;
    const businessType = document.getElementById('editType').value;
    
    const token = localStorage.getItem('healthpay_admin_token');
    
    try {
        const response = await fetch('http://104.248.245.150:4000/graphql', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            },
            body: JSON.stringify({
                query: `mutation AdminUpdateMerchant($id: ID!, $input: AdminUpdateMerchantInput!) {
                    adminUpdateMerchant(id: $id, input: $input) {
                        success
                        message
                        merchant { id name phone email businessName businessType status }
                    }
                }`,
                variables: { id: editingMerchantId, input: { name, email, businessName, businessType } }
            })
        });
        
        const result = await response.json();
        
        if (result.data?.adminUpdateMerchant?.success) {
            const index = merchants.findIndex(m => m.id === editingMerchantId);
            if (index !== -1) {
                merchants[index] = { ...merchants[index], name, email, businessName, type: businessType };
            }
            updateStats();
            filterMerchants();
            closeEditModal();
            alert('ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุชุงุฌุฑ ุจูุฌุงุญ');
        } else {
            alert('ุฎุทุฃ: ' + (result.data?.adminUpdateMerchant?.message || 'ูุดู ูู ุชุญุฏูุซ ุงูุชุงุฌุฑ'));
        }
    } catch (error) {
        console.error('Error updating merchant:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุชุงุฌุฑ');
    }
}

function viewTransactions(merchantId) {
    window.location.href = `transactions.html?merchantId=${merchantId}`;
}

function logout() {
    localStorage.removeItem('healthpay_admin_token');
    localStorage.removeItem('healthpay_admin_info');
    window.location.href = 'index.html';
}
</script>

</body>
</html>
